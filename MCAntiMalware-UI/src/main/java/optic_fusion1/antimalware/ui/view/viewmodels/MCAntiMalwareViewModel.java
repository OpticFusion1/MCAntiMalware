package optic_fusion1.antimalware.ui.view.viewmodels;

import javafx.beans.property.ListProperty;
import javafx.beans.property.SimpleListProperty;
import javafx.collections.FXCollections;
import optic_fusion1.antimalware.Main;
import optic_fusion1.antimalware.check.CheckResult;
import optic_fusion1.antimalware.ui.view.ViewModel;

import java.nio.file.Path;
import java.util.ArrayList;
import java.util.function.BiConsumer;

/**
 * The ViewModel for the {@link optic_fusion1.antimalware.ui.view.views.MCAntiMalwareView}.
 */
public class MCAntiMalwareViewModel implements ViewModel {

    private final ListProperty<Path> filesProperty = new SimpleListProperty<>(FXCollections.observableList(new ArrayList<>()));

    private final ListProperty<Path> scannedProperty = new SimpleListProperty<>(FXCollections.observableList(new ArrayList<>()));

    private BiConsumer<Path, CheckResult> onFound;

    /**
     * Adds a file to the list of files to be scanned.
     */
    public void registerFile(Path file) {
        if(!filesProperty.contains(file))
            filesProperty.add(file);
    }

    /**
     * Scans all registered files.
     */
    public void scanFiles() {

        if(filesProperty.isEmpty())
            return;

        for(Path file : filesProperty.get()) {
            Main.getAntiMalware().getScanner().addFileToQueue(file);
            scannedProperty.add(file);
        }

        scannedProperty.clear();
        filesProperty.clear();
    }

    /**
     * Sets the callback to be called when a file is found to be infected.
     */
    public void setOnFound(BiConsumer<Path, CheckResult> onFound) {
        this.onFound = onFound;
        Main.getAntiMalware().getNotificationHandler()
                .addReceiver(((path, checkResult) -> this.onFound.accept(path, checkResult)));
    }

    public ListProperty<Path> scannedProperty() {
        return scannedProperty;
    }

    public ListProperty<Path> filesProperty() {
        return filesProperty;
    }
}
