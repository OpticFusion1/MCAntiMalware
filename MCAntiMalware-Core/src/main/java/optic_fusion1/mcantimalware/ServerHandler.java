package optic_fusion1.mcantimalware;

import java.io.File;
import optic_fusion1.mcantimalware.logging.CustomLogger;
import optic_fusion1.mcantimalware.runtimeprotect.AntiMalwareSecurityManager;
import optic_fusion1.mcantimalware.runtimeprotect.PluginIndex;
import optic_fusion1.mcantimalware.scanner.Scanner;
import optic_fusion1.mcantimalware.utils.ReflectionUtils;
import optic_fusion1.mcantimalware.utils.Utils;
import optic_fusion1.mcantimalware.utils.javaagent.AgentLoader;

public class ServerHandler {

  private PluginIndex pluginIndex;
  private final CustomLogger logger;
  private final CommandLineParser commandLineParser;
  private boolean canUseSpigotMethods;
  private final Scanner scanner;
  private final Main main;

  public ServerHandler(Main main) {
    logger = main.getLogger();
    commandLineParser = main.getCommandLineParser();
    scanner = main.getScanner();
    this.main = main;
  }

  public void handleServer() {
    if (commandLineParser.shouldRunServerJar()) {
      File serverJar = commandLineParser.getServerJar();
      String[] serverArguments = commandLineParser.getServerArguments();
      scanner.scanFile(serverJar.toPath());
      startSpigotServer(serverJar, serverArguments);
      if (commandLineParser.shouldRunSecurityManager()) {
        logger.info("Setting up the Security Manager");
        SecurityManager mgr = new AntiMalwareSecurityManager(main);
        System.setSecurityManager(mgr);
        logger.info("Finished setting up the Security Manager");
      }
    }
  }

  /*
  TODO: Replace this with something better, perhaps checking one of the "MinecraftServer" fields
   */
  private boolean isLoadedEnough() {
    try {
      Class minecraftServerClass = ReflectionUtils.getNMSClass("MinecraftServer");
      return minecraftServerClass != null
              && org.bukkit.Bukkit.getConsoleSender() != null
              && org.bukkit.Bukkit.getPluginManager() != null;
    } catch (Exception ignored) {
    }
    return false;
  }

  private void startSpigotServer(File serverJar, String[] args) {
    if (!serverJar.exists()) {
      logger.info(serverJar + " isn't a valid jar");
      return;
    }
    Utils.loadLibrary(serverJar);
    org.bukkit.craftbukkit.Main.main(args);
    while (!isLoadedEnough()) {
    }
    canUseSpigotMethods = true;
    logger.info("Hooked into the server (" + ReflectionUtils.getFullVersion() + ")");
    if (commandLineParser.shouldUseTransformers()) {
      logger.info("Loading Transformers");
//      new RuntimeTransformer(AsyncPlayerChatEventTransformer.class);
//      new RuntimeTransformer(PlayerChatEventTransformer.class);
//      new RuntimeTransformer(SimplePluginManagerTransformer.class);
//      new RuntimeTransformer(ServerListPingEventTransformer.class);
//      String nmsVersion = ReflectionUtils.getVersion();
//      switch (nmsVersion) {
//        case "v1_8_R1":
//          new RuntimeTransformer(CraftPlayerTransformer1_8.class);
//          new RuntimeTransformer(CraftServerTransformer1_8.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_8.class);
//          new RuntimeTransformer(CraftEntityTransformer1_8.class);
//          new RuntimeTransformer(CraftBlockTransformer1_8.class);
//          break;
//        case "v1_8_R2":
//          new RuntimeTransformer(CraftPlayerTransformer1_8_3.class);
//          new RuntimeTransformer(CraftServerTransformer1_8_3.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_8_3.class);
//          new RuntimeTransformer(CraftEntityTransformer1_8_3.class);
//          new RuntimeTransformer(CraftBlockTransformer1_8_3.class);
//          break;
//        case "v1_8_R3":
//          new RuntimeTransformer(CraftPlayerTransformer1_8_8.class);
//          new RuntimeTransformer(CraftServerTransformer1_8_8.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_8_8.class);
//          new RuntimeTransformer(CraftEntityTransformer1_8_8.class);
//          new RuntimeTransformer(CraftBlockTransformer1_8_8.class);
//          break;
//        case "v1_9_R1":
//          new RuntimeTransformer(CraftPlayerTransformer1_9.class);
//          new RuntimeTransformer(CraftServerTransformer1_9.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_9.class);
//          new RuntimeTransformer(CraftEntityTransformer1_9.class);
//          new RuntimeTransformer(CraftBlockTransformer1_9.class);
//          break;
//        case "v1_9_R2":
//          new RuntimeTransformer(CraftPlayerTransformer1_9_4.class);
//          new RuntimeTransformer(CraftServerTransformer1_9_4.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_9_4.class);
//          new RuntimeTransformer(CraftEntityTransformer1_9_4.class);
//          new RuntimeTransformer(CraftBlockTransformer1_9_4.class);
//          break;
//        case "v1_10_R1":
//          new RuntimeTransformer(CraftPlayerTransformer1_10_2.class);
//          new RuntimeTransformer(CraftServerTransformer1_10_2.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_10_2.class);
//          new RuntimeTransformer(CraftEntityTransformer1_10_2.class);
//          new RuntimeTransformer(CraftBlockTransformer1_10_2.class);
//          break;
//        case "v1_11_R1":
//          new RuntimeTransformer(CraftPlayerTransformer1_11.class);
//          new RuntimeTransformer(CraftServerTransformer1_11.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_11.class);
//          new RuntimeTransformer(CraftEntityTransformer1_11.class);
//          new RuntimeTransformer(CraftBlockTransformer1_11.class);
//          break;
//        case "v1_12_R1":
//          new RuntimeTransformer(CraftPlayerTransformer1_12.class);
//          new RuntimeTransformer(CraftServerTransformer1_12.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_12.class);
//          new RuntimeTransformer(CraftEntityTransformer1_12.class);
//          new RuntimeTransformer(CraftBlockTransformer1_12.class);
//          break;
//        case "v1_13_R1":
//          new RuntimeTransformer(CraftPlayerTransformer1_13.class);
//          new RuntimeTransformer(CraftServerTransformer1_13.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_13.class);
//          new RuntimeTransformer(CraftEntityTransformer1_13.class);
//          new RuntimeTransformer(CraftBlockTransformer1_13.class);
//          break;
//        case "v1_13_R2":
//          new RuntimeTransformer(CraftPlayerTransformer1_13_R2.class);
//          new RuntimeTransformer(CraftServerTransformer1_13_R2.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_13_R2.class);
//          new RuntimeTransformer(CraftEntityTransformer1_13_R2.class);
//          new RuntimeTransformer(CraftBlockTransformer1_13_R2.class);
//          break;
//        case "v1_14_R1":
//          new RuntimeTransformer(CraftPlayerTransformer1_14.class);
//          new RuntimeTransformer(CraftServerTransformer1_14.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_14.class);
//          new RuntimeTransformer(CraftEntityTransformer1_14.class);
//          new RuntimeTransformer(CraftBlockTransformer1_14.class);
//          break;
//        case "v1_15_R1":
//          new RuntimeTransformer(CraftPlayerTransformer1_15.class);
//          new RuntimeTransformer(CraftServerTransformer1_15.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_15.class);
//          new RuntimeTransformer(CraftEntityTransformer1_15.class);
//          new RuntimeTransformer(CraftBlockTransformer1_15.class);
//          break;
//        case "v1_16_R1":
//          new RuntimeTransformer(CraftPlayerTransformer1_16_1.class);
//          new RuntimeTransformer(CraftServerTransformer1_16_1.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_16_1.class);
//          new RuntimeTransformer(CraftEntityTransformer1_16_1.class);
//          new RuntimeTransformer(CraftBlockTransformer1_16_1.class);
//          break;
//        case "v1_16_R2":
//          new RuntimeTransformer(CraftPlayerTransformer1_16_2.class);
//          new RuntimeTransformer(CraftServerTransformer1_16_2.class);
//          new RuntimeTransformer(CraftInventoryTransformer1_16_2.class);
//          new RuntimeTransformer(CraftEntityTransformer1_16_2.class);
//          new RuntimeTransformer(CraftBlockTransformer1_16_2.class);
//          break;
//        default:
//          break;
//      }
    }
    if (commandLineParser.shouldDumpClasses()) {
      logger.info("Dumping classes");
      try {
        AgentLoader.loadAgentClass(Main.class.getName());
      } catch (Exception ex) {
        logger.exception(ex);
      }
    }
  }

  public PluginIndex getPluginIndex() {
    return pluginIndex;
  }

  public boolean canUseSpigotMethods() {
    return canUseSpigotMethods;
  }
}
