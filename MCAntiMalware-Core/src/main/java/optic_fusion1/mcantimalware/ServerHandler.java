package optic_fusion1.mcantimalware;

import java.io.File;
import me.yamakaja.runtimetransformer.RuntimeTransformer;
import optic_fusion1.mcantimalware.logging.CustomLogger;
import optic_fusion1.mcantimalware.runtimeprotect.AntiMalwareSecurityManager;
import optic_fusion1.mcantimalware.runtimeprotect.PluginIndex;
import optic_fusion1.mcantimalware.scanner.Scanner;
import optic_fusion1.mcantimalware.transformer.AsyncPlayerChatEventTransformer;
import optic_fusion1.mcantimalware.transformer.PlayerChatEventTransformer;
import optic_fusion1.mcantimalware.transformer.ServerListPingEventTransformer;
import optic_fusion1.mcantimalware.transformer.SimplePluginManagerTransformer;
import optic_fusion1.mcantimalware.transformer.v1_10_2.CraftBlockTransformer1_10_2;
import optic_fusion1.mcantimalware.transformer.v1_10_2.CraftEntityTransformer1_10_2;
import optic_fusion1.mcantimalware.transformer.v1_10_2.CraftInventoryTransformer1_10_2;
import optic_fusion1.mcantimalware.transformer.v1_10_2.CraftPlayerTransformer1_10_2;
import optic_fusion1.mcantimalware.transformer.v1_10_2.CraftServerTransformer1_10_2;
import optic_fusion1.mcantimalware.transformer.v1_11.CraftBlockTransformer1_11;
import optic_fusion1.mcantimalware.transformer.v1_11.CraftEntityTransformer1_11;
import optic_fusion1.mcantimalware.transformer.v1_11.CraftInventoryTransformer1_11;
import optic_fusion1.mcantimalware.transformer.v1_11.CraftPlayerTransformer1_11;
import optic_fusion1.mcantimalware.transformer.v1_11.CraftServerTransformer1_11;
import optic_fusion1.mcantimalware.transformer.v1_12.CraftBlockTransformer1_12;
import optic_fusion1.mcantimalware.transformer.v1_12.CraftEntityTransformer1_12;
import optic_fusion1.mcantimalware.transformer.v1_12.CraftInventoryTransformer1_12;
import optic_fusion1.mcantimalware.transformer.v1_12.CraftPlayerTransformer1_12;
import optic_fusion1.mcantimalware.transformer.v1_12.CraftServerTransformer1_12;
import optic_fusion1.mcantimalware.transformer.v1_13.CraftBlockTransformer1_13;
import optic_fusion1.mcantimalware.transformer.v1_13.CraftEntityTransformer1_13;
import optic_fusion1.mcantimalware.transformer.v1_13.CraftInventoryTransformer1_13;
import optic_fusion1.mcantimalware.transformer.v1_13.CraftPlayerTransformer1_13;
import optic_fusion1.mcantimalware.transformer.v1_13.CraftServerTransformer1_13;
import optic_fusion1.mcantimalware.transformer.v1_13_R2.CraftBlockTransformer1_13_R2;
import optic_fusion1.mcantimalware.transformer.v1_13_R2.CraftEntityTransformer1_13_R2;
import optic_fusion1.mcantimalware.transformer.v1_13_R2.CraftInventoryTransformer1_13_R2;
import optic_fusion1.mcantimalware.transformer.v1_13_R2.CraftPlayerTransformer1_13_R2;
import optic_fusion1.mcantimalware.transformer.v1_13_R2.CraftServerTransformer1_13_R2;
import optic_fusion1.mcantimalware.transformer.v1_14.CraftBlockTransformer1_14;
import optic_fusion1.mcantimalware.transformer.v1_14.CraftEntityTransformer1_14;
import optic_fusion1.mcantimalware.transformer.v1_14.CraftInventoryTransformer1_14;
import optic_fusion1.mcantimalware.transformer.v1_14.CraftPlayerTransformer1_14;
import optic_fusion1.mcantimalware.transformer.v1_14.CraftServerTransformer1_14;
import optic_fusion1.mcantimalware.transformer.v1_15.CraftBlockTransformer1_15;
import optic_fusion1.mcantimalware.transformer.v1_15.CraftEntityTransformer1_15;
import optic_fusion1.mcantimalware.transformer.v1_15.CraftInventoryTransformer1_15;
import optic_fusion1.mcantimalware.transformer.v1_15.CraftPlayerTransformer1_15;
import optic_fusion1.mcantimalware.transformer.v1_15.CraftServerTransformer1_15;
import optic_fusion1.mcantimalware.transformer.v1_16_1.CraftBlockTransformer1_16_1;
import optic_fusion1.mcantimalware.transformer.v1_16_1.CraftEntityTransformer1_16_1;
import optic_fusion1.mcantimalware.transformer.v1_16_1.CraftInventoryTransformer1_16_1;
import optic_fusion1.mcantimalware.transformer.v1_16_1.CraftPlayerTransformer1_16_1;
import optic_fusion1.mcantimalware.transformer.v1_16_1.CraftServerTransformer1_16_1;
import optic_fusion1.mcantimalware.transformer.v1_16_2.CraftBlockTransformer1_16_2;
import optic_fusion1.mcantimalware.transformer.v1_16_2.CraftEntityTransformer1_16_2;
import optic_fusion1.mcantimalware.transformer.v1_16_2.CraftInventoryTransformer1_16_2;
import optic_fusion1.mcantimalware.transformer.v1_16_2.CraftPlayerTransformer1_16_2;
import optic_fusion1.mcantimalware.transformer.v1_16_2.CraftServerTransformer1_16_2;
import optic_fusion1.mcantimalware.transformer.v1_8.CraftBlockTransformer1_8;
import optic_fusion1.mcantimalware.transformer.v1_8.CraftEntityTransformer1_8;
import optic_fusion1.mcantimalware.transformer.v1_8.CraftInventoryTransformer1_8;
import optic_fusion1.mcantimalware.transformer.v1_8.CraftPlayerTransformer1_8;
import optic_fusion1.mcantimalware.transformer.v1_8.CraftServerTransformer1_8;
import optic_fusion1.mcantimalware.transformer.v1_8_3.CraftBlockTransformer1_8_3;
import optic_fusion1.mcantimalware.transformer.v1_8_3.CraftEntityTransformer1_8_3;
import optic_fusion1.mcantimalware.transformer.v1_8_3.CraftInventoryTransformer1_8_3;
import optic_fusion1.mcantimalware.transformer.v1_8_3.CraftPlayerTransformer1_8_3;
import optic_fusion1.mcantimalware.transformer.v1_8_3.CraftServerTransformer1_8_3;
import optic_fusion1.mcantimalware.transformer.v1_8_8.CraftBlockTransformer1_8_8;
import optic_fusion1.mcantimalware.transformer.v1_8_8.CraftEntityTransformer1_8_8;
import optic_fusion1.mcantimalware.transformer.v1_8_8.CraftInventoryTransformer1_8_8;
import optic_fusion1.mcantimalware.transformer.v1_8_8.CraftPlayerTransformer1_8_8;
import optic_fusion1.mcantimalware.transformer.v1_8_8.CraftServerTransformer1_8_8;
import optic_fusion1.mcantimalware.transformer.v1_9.CraftBlockTransformer1_9;
import optic_fusion1.mcantimalware.transformer.v1_9.CraftEntityTransformer1_9;
import optic_fusion1.mcantimalware.transformer.v1_9.CraftInventoryTransformer1_9;
import optic_fusion1.mcantimalware.transformer.v1_9.CraftPlayerTransformer1_9;
import optic_fusion1.mcantimalware.transformer.v1_9.CraftServerTransformer1_9;
import optic_fusion1.mcantimalware.transformer.v1_9_4.CraftBlockTransformer1_9_4;
import optic_fusion1.mcantimalware.transformer.v1_9_4.CraftEntityTransformer1_9_4;
import optic_fusion1.mcantimalware.transformer.v1_9_4.CraftInventoryTransformer1_9_4;
import optic_fusion1.mcantimalware.transformer.v1_9_4.CraftPlayerTransformer1_9_4;
import optic_fusion1.mcantimalware.transformer.v1_9_4.CraftServerTransformer1_9_4;
import optic_fusion1.mcantimalware.utils.ReflectionUtils;
import optic_fusion1.mcantimalware.utils.Utils;
import optic_fusion1.mcantimalware.utils.javaagent.AgentLoader;

public class ServerHandler {

  private PluginIndex pluginIndex;
  private final CustomLogger logger;
  private final CommandLineParser commandLineParser;
  private boolean canUseSpigotMethods;
  private final Scanner scanner;
  private final Main main;

  public ServerHandler(Main main) {
    logger = main.getLogger();
    commandLineParser = main.getCommandLineParser();
    scanner = main.getScanner();
    this.main = main;
  }

  public void handleServer() {
    if (commandLineParser.shouldRunServerJar()) {
      File serverJar = commandLineParser.getServerJar();
      String[] serverArguments = commandLineParser.getServerArguments();
      scanner.scanFile(serverJar.toPath());
      startSpigotServer(serverJar, serverArguments);
      if (commandLineParser.shouldRunSecurityManager()) {
        logger.info("Setting up the Security Manager");
        SecurityManager mgr = new AntiMalwareSecurityManager(main);
        System.setSecurityManager(mgr);
        logger.info("Finished setting up the Security Manager");
      }
    }
  }

  /*
  TODO: Replace this with something better, perhaps checking one of the "MinecraftServer" fields
   */
  private boolean isLoadedEnough() {
    try {
      Class minecraftServerClass = ReflectionUtils.getNMSClass("MinecraftServer");
      return minecraftServerClass != null
              && org.bukkit.Bukkit.getConsoleSender() != null
              && org.bukkit.Bukkit.getPluginManager() != null;
    } catch (Exception ignored) {
    }
    return false;
  }

  private void startSpigotServer(File serverJar, String[] args) {
    if (!serverJar.exists()) {
      logger.info(serverJar + " isn't a valid jar");
      return;
    }
    Utils.loadLibrary(serverJar);
    org.bukkit.craftbukkit.Main.main(args);
    while (!isLoadedEnough()) {
    }
    canUseSpigotMethods = true;
    logger.info("Hooked into the server (" + ReflectionUtils.getFullVersion() + ")");
    if (commandLineParser.shouldUseTransformers()) {
      logger.info("Loading Transformers");
      new RuntimeTransformer(AsyncPlayerChatEventTransformer.class);
      new RuntimeTransformer(PlayerChatEventTransformer.class);
      new RuntimeTransformer(SimplePluginManagerTransformer.class);
      new RuntimeTransformer(ServerListPingEventTransformer.class);
      String nmsVersion = ReflectionUtils.getVersion();
      switch (nmsVersion) {
        case "v1_8_R1":
          new RuntimeTransformer(CraftPlayerTransformer1_8.class);
          new RuntimeTransformer(CraftServerTransformer1_8.class);
          new RuntimeTransformer(CraftInventoryTransformer1_8.class);
          new RuntimeTransformer(CraftEntityTransformer1_8.class);
          new RuntimeTransformer(CraftBlockTransformer1_8.class);
          break;
        case "v1_8_R2":
          new RuntimeTransformer(CraftPlayerTransformer1_8_3.class);
          new RuntimeTransformer(CraftServerTransformer1_8_3.class);
          new RuntimeTransformer(CraftInventoryTransformer1_8_3.class);
          new RuntimeTransformer(CraftEntityTransformer1_8_3.class);
          new RuntimeTransformer(CraftBlockTransformer1_8_3.class);
          break;
        case "v1_8_R3":
          new RuntimeTransformer(CraftPlayerTransformer1_8_8.class);
          new RuntimeTransformer(CraftServerTransformer1_8_8.class);
          new RuntimeTransformer(CraftInventoryTransformer1_8_8.class);
          new RuntimeTransformer(CraftEntityTransformer1_8_8.class);
          new RuntimeTransformer(CraftBlockTransformer1_8_8.class);
          break;
        case "v1_9_R1":
          new RuntimeTransformer(CraftPlayerTransformer1_9.class);
          new RuntimeTransformer(CraftServerTransformer1_9.class);
          new RuntimeTransformer(CraftInventoryTransformer1_9.class);
          new RuntimeTransformer(CraftEntityTransformer1_9.class);
          new RuntimeTransformer(CraftBlockTransformer1_9.class);
          break;
        case "v1_9_R2":
          new RuntimeTransformer(CraftPlayerTransformer1_9_4.class);
          new RuntimeTransformer(CraftServerTransformer1_9_4.class);
          new RuntimeTransformer(CraftInventoryTransformer1_9_4.class);
          new RuntimeTransformer(CraftEntityTransformer1_9_4.class);
          new RuntimeTransformer(CraftBlockTransformer1_9_4.class);
          break;
        case "v1_10_R1":
          new RuntimeTransformer(CraftPlayerTransformer1_10_2.class);
          new RuntimeTransformer(CraftServerTransformer1_10_2.class);
          new RuntimeTransformer(CraftInventoryTransformer1_10_2.class);
          new RuntimeTransformer(CraftEntityTransformer1_10_2.class);
          new RuntimeTransformer(CraftBlockTransformer1_10_2.class);
          break;
        case "v1_11_R1":
          new RuntimeTransformer(CraftPlayerTransformer1_11.class);
          new RuntimeTransformer(CraftServerTransformer1_11.class);
          new RuntimeTransformer(CraftInventoryTransformer1_11.class);
          new RuntimeTransformer(CraftEntityTransformer1_11.class);
          new RuntimeTransformer(CraftBlockTransformer1_11.class);
          break;
        case "v1_12_R1":
          new RuntimeTransformer(CraftPlayerTransformer1_12.class);
          new RuntimeTransformer(CraftServerTransformer1_12.class);
          new RuntimeTransformer(CraftInventoryTransformer1_12.class);
          new RuntimeTransformer(CraftEntityTransformer1_12.class);
          new RuntimeTransformer(CraftBlockTransformer1_12.class);
          break;
        case "v1_13_R1":
          new RuntimeTransformer(CraftPlayerTransformer1_13.class);
          new RuntimeTransformer(CraftServerTransformer1_13.class);
          new RuntimeTransformer(CraftInventoryTransformer1_13.class);
          new RuntimeTransformer(CraftEntityTransformer1_13.class);
          new RuntimeTransformer(CraftBlockTransformer1_13.class);
          break;
        case "v1_13_R2":
          new RuntimeTransformer(CraftPlayerTransformer1_13_R2.class);
          new RuntimeTransformer(CraftServerTransformer1_13_R2.class);
          new RuntimeTransformer(CraftInventoryTransformer1_13_R2.class);
          new RuntimeTransformer(CraftEntityTransformer1_13_R2.class);
          new RuntimeTransformer(CraftBlockTransformer1_13_R2.class);
          break;
        case "v1_14_R1":
          new RuntimeTransformer(CraftPlayerTransformer1_14.class);
          new RuntimeTransformer(CraftServerTransformer1_14.class);
          new RuntimeTransformer(CraftInventoryTransformer1_14.class);
          new RuntimeTransformer(CraftEntityTransformer1_14.class);
          new RuntimeTransformer(CraftBlockTransformer1_14.class);
          break;
        case "v1_15_R1":
          new RuntimeTransformer(CraftPlayerTransformer1_15.class);
          new RuntimeTransformer(CraftServerTransformer1_15.class);
          new RuntimeTransformer(CraftInventoryTransformer1_15.class);
          new RuntimeTransformer(CraftEntityTransformer1_15.class);
          new RuntimeTransformer(CraftBlockTransformer1_15.class);
          break;
        case "v1_16_R1":
          new RuntimeTransformer(CraftPlayerTransformer1_16_1.class);
          new RuntimeTransformer(CraftServerTransformer1_16_1.class);
          new RuntimeTransformer(CraftInventoryTransformer1_16_1.class);
          new RuntimeTransformer(CraftEntityTransformer1_16_1.class);
          new RuntimeTransformer(CraftBlockTransformer1_16_1.class);
          break;
        case "v1_16_R2":
          new RuntimeTransformer(CraftPlayerTransformer1_16_2.class);
          new RuntimeTransformer(CraftServerTransformer1_16_2.class);
          new RuntimeTransformer(CraftInventoryTransformer1_16_2.class);
          new RuntimeTransformer(CraftEntityTransformer1_16_2.class);
          new RuntimeTransformer(CraftBlockTransformer1_16_2.class);
          break;
        default:
          break;
      }
    }
    if (commandLineParser.shouldDumpClasses()) {
      logger.info("Dumping classes");
      try {
        AgentLoader.loadAgentClass(Main.class.getName());
      } catch (Exception ex) {
        logger.exception(ex);
      }
    }
  }

  public PluginIndex getPluginIndex() {
    return pluginIndex;
  }

  public boolean canUseSpigotMethods() {
    return canUseSpigotMethods;
  }
}
