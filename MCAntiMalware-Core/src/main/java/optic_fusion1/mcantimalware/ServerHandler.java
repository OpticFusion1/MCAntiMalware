package optic_fusion1.mcantimalware;

import java.io.File;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.net.URL;
import java.net.URLClassLoader;
import net.bytebuddy.dynamic.ClassFileLocator;
import optic_fusion1.mcantimalware.logging.CustomLogger;
import optic_fusion1.mcantimalware.runtimeprotect.AntiMalwareSecurityManager;
import optic_fusion1.mcantimalware.runtimeprotect.PluginIndex;
import optic_fusion1.mcantimalware.scanner.Scanner;
import optic_fusion1.mcantimalware.transformers.Transformers;
import optic_fusion1.mcantimalware.utils.I18n;
import optic_fusion1.mcantimalware.utils.ReflectionUtils;

public class ServerHandler {

  private PluginIndex pluginIndex;
  private final CustomLogger logger;
  private final CommandLineParser commandLineParser;
  private boolean canUseSpigotMethods;
  private final Scanner scanner;
  private final Main main;

  public ServerHandler(Main main) {
    logger = main.getLogger();
    commandLineParser = main.getCommandLineParser();
    scanner = main.getScanner();
    this.main = main;
  }

  public void handleServer() {
    if (commandLineParser.shouldRunServerJar()) {
      File serverJar = commandLineParser.getServerJar();
      scanner.addFileToQueue(serverJar.toPath());
      startSpigotServer(serverJar, commandLineParser.getServerArguments());
      if (commandLineParser.shouldRunSecurityManager()) {
        logger.info(I18n.tl("start_sm_setup"));
        System.setSecurityManager(new AntiMalwareSecurityManager(main));
        logger.info(I18n.tl("end_sm_setup"));
      }
    }
  }

  private void startSpigotServer(File serverJar, String[] args) {
    if (!serverJar.exists()) {
      logger.info(I18n.tl("file_doesn't_exist", serverJar));
      return;
    }

    try {

      URL jarURL = serverJar.toURI().toURL();
      final ClassLoader parentClassLoader = new URLClassLoader(new URL[]{jarURL},
              ClassLoader.getSystemClassLoader());

      if (commandLineParser.shouldUseTransformers()) {
        logger.info(I18n.tl("start_sm_load_transformers"));
        Transformers.applyTransformers(parentClassLoader, ClassFileLocator.ForJarFile.of(serverJar),
                ReflectionUtils.getVersion(serverJar));
        logger.info(I18n.tl("end_sm_load_transformers"));
      }

      new Thread(() -> {
        try {
          Thread.currentThread().setContextClassLoader(parentClassLoader);
          logger.info(I18n.tl("sm_start_server"));
          parentClassLoader.loadClass("org.bukkit.craftbukkit.Main").getMethod("main", String[].class).invoke(null,
                  (Object) args);
        } catch (IllegalAccessException | IllegalArgumentException | InvocationTargetException | NoSuchMethodException
                | SecurityException | ClassNotFoundException e) {
          logger.exception(e);
        }
      }).start();

      canUseSpigotMethods = true;
      logger.info(I18n.tl("sm_server_hooked", ReflectionUtils.getVersion(serverJar)));
      if (commandLineParser.shouldDumpClasses()) {
        logger.info(I18n.tl("sm_dumping_classes"));
      }
    } catch (IOException e) {
      logger.exception(e);
    }
  }

  public PluginIndex getPluginIndex() {
    return pluginIndex;
  }

  public boolean canUseSpigotMethods() {
    return canUseSpigotMethods;
  }
}
