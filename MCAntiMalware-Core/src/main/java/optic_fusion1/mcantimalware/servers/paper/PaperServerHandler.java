package optic_fusion1.mcantimalware.servers.paper;

import java.io.File;
import java.io.IOException;
import java.net.MalformedURLException;
import java.net.URL;
import java.nio.file.FileSystem;
import java.nio.file.Files;

import optic_fusion1.mcantimalware.servers.ServerHandler;
import optic_fusion1.mcantimalware.utils.I18n;
import optic_fusion1.mcantimalware.utils.ReflectionUtils;
import optic_fusion1.mcantimalware.utils.Utils;

public class PaperServerHandler extends ServerHandler {

	private File serverJar;
	private String version;

	@Override
	protected boolean checkServerType(File serverFile) {
		try (FileSystem fs = Utils.fileSystemForZip(serverFile.toPath())) {
			if (Files.exists(fs.getPath("patch.properties"))) {
				return true;
			}
		} catch (IOException e) {
			logger.exception(e);
		}
		return false;
	}

	@Override
	protected boolean prepareServer() {
		if (!getServerFile().exists()) {
			logger.info(I18n.tl("file_doesn't_exist", getServerFile()));
			return false;
		}
		ClassLoader patchClassLoader = null;
		try {
			patchClassLoader = createClassLoader(getServerFile().toURI().toURL());
		} catch (MalformedURLException e) {
			logger.exception(e);
			return false;
		}
		SecurityManager oldSM = System.getSecurityManager();
		PaperPatchingSecurityManager ppsm = new PaperPatchingSecurityManager();
		setSecurityManager(ppsm);
		System.setProperty("paperclip.patchonly", "true");
		Thread patchThread = createChildProcess(patchClassLoader, "io.papermc.paperclip.Paperclip", "main",
				new Class<?>[] { String[].class }, new Object[] { new String[0] });
		try {
			patchThread.join();
		} catch (InterruptedException e) {
			logger.exception(e);
			return false;
		}
		serverJar = new File(ppsm.getPaperPatchedJarFile());
		setSecurityManager(oldSM);
		this.version = ReflectionUtils.getVersion(serverJar);
		if (version.equals(I18n.tl("version_used_not_found"))) {
			return false;
		}
		return true;
	}

	@Override
	protected void startServer() {
		try {
			URL jarURL = serverJar.toURI().toURL();
			final ClassLoader parentClassLoader = createClassLoader(jarURL);

			if (commandLineParser.shouldUseTransformers()) {
				applyTransformers(parentClassLoader, serverJar, version);
			}

			Thread childProcess = createChildProcess(parentClassLoader, "org.bukkit.craftbukkit.Main", "main",
					new Class[] { String[].class }, new Object[] { getServerArguments() });

			canUseSpigotMethods = true;
			logger.info(I18n.tl("sm_server_hooked", version));
			if (commandLineParser.shouldDumpClasses()) {
				logger.info(I18n.tl("sm_dumping_classes"));
			}
		} catch (IOException e) {
			logger.exception(e);
		}
	}

	@Override
	public String getServerTypeName() {
		return "Paper";
	}

}
