package optic_fusion1.mcantimalware.transformers;

import static net.bytebuddy.matcher.ElementMatchers.nameStartsWith;
import static net.bytebuddy.matcher.ElementMatchers.named;

import java.util.logging.Logger;

import net.bytebuddy.ByteBuddy;
import net.bytebuddy.dynamic.ClassFileLocator;
import net.bytebuddy.dynamic.loading.ClassLoadingStrategy;
import net.bytebuddy.dynamic.scaffold.TypeValidation;
import net.bytebuddy.implementation.MethodDelegation;
import net.bytebuddy.pool.TypePool;

public class Transformers {

  public static void applyTransformers(ClassLoader parentClassLoader, ClassFileLocator serverJar, String version) {
	ByteBuddy buddy = new ByteBuddy();

	TypePool typePool = TypePool.Default.of(
		new ClassFileLocator.Compound(serverJar, ClassFileLocator.ForClassLoader.of(Logger.class.getClassLoader())));

	buddy.rebase(typePool.describe("org.bukkit.craftbukkit." + version + ".block.CraftBlock").resolve(), serverJar)
		.method(nameStartsWith("setType")).intercept(MethodDelegation.to(CraftBlockTransformer.class)).make()
		.load(parentClassLoader, ClassLoadingStrategy.Default.INJECTION);

	buddy.rebase(typePool.describe("org.bukkit.event.player.AsyncPlayerChatEvent").resolve(), serverJar)
		.method(named("setMessage").or(named("setCancelled")))
		.intercept(MethodDelegation.to(AsyncPlayerChatEventTransformer.class)).make()
		.load(parentClassLoader, ClassLoadingStrategy.Default.INJECTION);

	buddy.rebase(typePool.describe("org.bukkit.event.player.PlayerChatEvent").resolve(), serverJar)
		.method(named("setMessage").or(named("setCancelled")))
		.intercept(MethodDelegation.to(PlayerChatEventTransformer.class)).make()
		.load(parentClassLoader, ClassLoadingStrategy.Default.INJECTION);

	buddy.with(TypeValidation.DISABLED)
		.rebase(typePool.describe("org.bukkit.event.server.ServerListPingEvent").resolve(), serverJar)
		.method(named("setMotd").or(named("setMaxPlayers")))
		.intercept(MethodDelegation.to(ServerListPingEventTransformer.class)).make()
		.load(parentClassLoader, ClassLoadingStrategy.Default.INJECTION);

	buddy.rebase(typePool.describe("org.bukkit.plugin.SimplePluginManager").resolve(), serverJar)
		.method(nameStartsWith("disablePlugin").or(named("enablePlugin")))
		.intercept(MethodDelegation.to(SimplePluginManagerTransformer.class)).make()
		.load(parentClassLoader, ClassLoadingStrategy.Default.INJECTION);

	buddy.rebase(typePool.describe("org.bukkit.craftbukkit." + version + ".entity.CraftEntity").resolve(), serverJar)
		.method(named("teleport").or(named("setPassenger").or(named("setVelocity"))))
		.intercept(MethodDelegation.to(CraftEntityTransformer.class)).make()
		.load(parentClassLoader, ClassLoadingStrategy.Default.INJECTION);

	buddy
		.rebase(typePool.describe("org.bukkit.craftbukkit." + version + ".inventory.CraftInventory").resolve(),
			serverJar)
		.method(named("getContents").or(named("setContents").or(named("addItem"))))
		.intercept(MethodDelegation.to(CraftInventoryTransformer.class)).make()
		.load(parentClassLoader, ClassLoadingStrategy.Default.INJECTION);

	buddy.with(TypeValidation.DISABLED)
		.rebase(typePool.describe("org.bukkit.craftbukkit." + version + ".entity.CraftPlayer").resolve(), serverJar)
		.method(nameStartsWith("send")
			.or(nameStartsWith("play").or(nameStartsWith("set").or(named("chat").or(named("kickPlayer"))))))
		.intercept(MethodDelegation.to(CraftPlayerTransformer.class)).make()
		.load(parentClassLoader, ClassLoadingStrategy.Default.INJECTION);

	buddy.rebase(typePool.describe("org.bukkit.craftbukkit." + version + ".CraftServer").resolve(), serverJar)
		.method(nameStartsWith("broadcast").or(nameStartsWith("dispatch")))
		.intercept(MethodDelegation.to(CraftServerTransformer.class)).make()
		.load(parentClassLoader, ClassLoadingStrategy.Default.INJECTION);
  }

}
