package optic_fusion1.mcantimalware.check;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.HashMap;
import java.util.Map;
import static optic_fusion1.mcantimalware.Main.LOGGER;
import optic_fusion1.mcantimalware.configuration.file.YamlConfiguration;
import optic_fusion1.mcantimalware.logging.CustomLevel;
import org.apache.commons.codec.digest.DigestUtils;
import org.objectweb.asm.ClassReader;
import org.objectweb.asm.tree.ClassNode;

public class CacheContainer {

  private final Map<Path, ClassNode> cachedClasses = new HashMap<>();
  private final Map<Path, YamlConfiguration> cachedConfigurations = new HashMap<>();
  private final Map<Path, String> cachedHashes = new HashMap<>();

  public ClassNode fetchClass(Path path) {
    try {
      if (!cachedClasses.containsKey(path)) {
        loadClass(path);
      }
      return cachedClasses.get(path);
    } catch (Exception e) {
      return null;
    }
  }

  private void loadClass(Path path) {
    try {
      ClassReader classReader = new ClassReader(Files.newInputStream(path));
      ClassNode classNode = new ClassNode();
      classReader.accept(classNode, 0);
      cachedClasses.put(path, classNode);
    } catch (IOException e) {
      LOGGER.log("Wasn't able to read Class " + path.toUri().toString() + "", CustomLevel.WARNING, false);
      cachedClasses.put(path, null);
    }
  }

  public YamlConfiguration fetchConfiguration(Path path) {
    if (!cachedConfigurations.containsKey(path)) {
      loadConfiguration(path);
    }
    return cachedConfigurations.get(path);
  }

  private void loadConfiguration(Path path) {
    try {
      cachedConfigurations.put(path, YamlConfiguration.loadConfiguration(Files.newInputStream(path)));
    } catch (IOException e) {
      cachedConfigurations.put(path, null);
    }
  }

  public String fetchSHA1(Path path) {
    if (!cachedHashes.containsKey(path)) {
      loadSHA1(path);
    }
    return cachedHashes.get(path);
  }

  public void loadSHA1(Path path) {
    try {
      cachedHashes.put(path, DigestUtils.sha1Hex(Files.newInputStream(path)));
    } catch (IOException e) {
      cachedHashes.put(path, "");
    }
  }

}
