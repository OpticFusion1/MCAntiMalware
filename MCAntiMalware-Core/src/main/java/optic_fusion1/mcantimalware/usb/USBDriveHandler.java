package optic_fusion1.mcantimalware.usb;

import java.io.File;
import java.io.IOException;
import net.samuelcampos.usbdrivedetector.USBDeviceDetectorManager;
import net.samuelcampos.usbdrivedetector.events.DeviceEventType;
import net.samuelcampos.usbdrivedetector.events.IUSBDriveListener;
import net.samuelcampos.usbdrivedetector.events.USBStorageEvent;
import optic_fusion1.mcantimalware.AntiMalware;
import optic_fusion1.mcantimalware.AntiMalwareAPI;
import optic_fusion1.mcantimalware.Main;
import optic_fusion1.mcantimalware.realtimescanning.Scanner;

public class USBDriveHandler implements IUSBDriveListener {

	private Scanner scanner;
	private boolean shouldExceptionsBeLogged;

	public USBDriveHandler(Main main) {
		scanner = main.getRealTimeScanner().getScanner();
		shouldExceptionsBeLogged = main.getCommandLineHandler().shouldExceptionsBeLogged();
		USBDeviceDetectorManager driveDetector = new USBDeviceDetectorManager();
		driveDetector.addDriveListener(this);
		driveDetector.setPollingInterval(1);
	}

	@Override
	public void usbDriveEvent(USBStorageEvent event) {
		if (event.getEventType() == DeviceEventType.CONNECTED) {
			for (File file : event.getStorageDevice().getRootDirectory().listFiles()) {
				if (file.isDirectory()) {
					scanner.scanDirectory(file);
				} else {
					try {
						scanner.scanFile(file);
					} catch (IOException ex) {
						if (shouldExceptionsBeLogged) {
							AntiMalwareAPI.getInstance().getLogger().exception(ex);
						}
					}
				}
			}
		}
	}

}
