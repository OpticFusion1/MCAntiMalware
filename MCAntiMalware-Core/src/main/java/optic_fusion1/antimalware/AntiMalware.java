/*
* Copyright (C) 2021 Optic_Fusion1
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package optic_fusion1.antimalware;

import optic_fusion1.antimalware.check.CacheContainer;
import optic_fusion1.antimalware.check.CheckManager;
import optic_fusion1.antimalware.check.CheckRegistery;
import optic_fusion1.antimalware.database.Database;
import optic_fusion1.antimalware.logging.CustomLogger;
import optic_fusion1.antimalware.metrics.MetricsManager;
import optic_fusion1.antimalware.metrics.metric.JVMMetric;
import optic_fusion1.antimalware.metrics.metric.MemoryMetric;
import optic_fusion1.antimalware.notifications.NotificationHandler;
import optic_fusion1.antimalware.scanner.Scanner;
import optic_fusion1.antimalware.scanner.USBDriveScanner;
import optic_fusion1.antimalware.scanner.realtime.RealTimeScanner;
import optic_fusion1.antimalware.servers.handler.PlayerBanHandler;
import optic_fusion1.antimalware.servers.handler.ServerHandler;
import optic_fusion1.antimalware.utils.I18n;

import java.io.File;

public class AntiMalware extends Thread {

  public static final CustomLogger LOGGER = new CustomLogger();
  private static final Database DATABASE = new Database();
  private static final CheckManager CHECK_MANAGER = new CheckManager();
  private static AntiMalware instance;
  private final CommandLineParser parser;
  private NotificationHandler notifHandler;
  private MetricsManager metrics;
  private Scanner scanner;
  private ServerHandler serverHandler;
  private CacheContainer cache;

  public AntiMalware(String[] args) {
    setName("AntiMalware/Main");
    Thread.setDefaultUncaughtExceptionHandler((Thread t, Throwable e) -> {
      LOGGER.warn("Uncaught exception");
      LOGGER.exception(e);
    });
    (parser = new CommandLineParser()).parseArguments(args);
    instance = this;
  }

  @Override
  public void run() {
    init();
  }

  private void init() {
    LOGGER.info(I18n.tl("initializing_start"));
    LOGGER.info(I18n.tl("github_issues"));
    cache = new CacheContainer(DATABASE);
    notifHandler = new NotificationHandler(parser.getNotificationType());
    if (parser.shouldUseMetrics()) {
      (metrics = new MetricsManager(this)).registerMetrics(new JVMMetric(), new MemoryMetric()).start();
    }
    notifHandler = new NotificationHandler(parser.getNotificationType());
    if (parser.shouldBanMaliciousAuthors() && new File("banned-players.json").exists()) {
      new PlayerBanHandler().start();
    }
    new CheckRegistery(this).registerChecks();
    if (parser.singleScan() || parser.shouldScanSingleFile()) {
      scanner = new RealTimeScanner(this, parser.getScanDirectory());
      if (parser.shouldScanSingleFile()) {
        scanner.addFileToQueue(parser.getScanFile().toPath());
      } else {
        scanner.scanFiles();
      }
      return;
    } else {
      scanner = new RealTimeScanner(this, parser.getScanDirectory());
    }
    if (!parser.shouldDisableAutoUpdate()) {
      LOGGER.info(I18n.tl("setup_auto_update"));
      new Updater(this).start();
    }
    if (parser.shouldRunServerJar()) {
      serverHandler = ServerHandler.getServerHandler(this);
      if (serverHandler != null) {
        serverHandler.handleServer();
        LOGGER.info(I18n.tl("server_type", serverHandler.getServerTypeName()));
      }
    }
    if (parser.shouldScanDrives()) {
      new USBDriveScanner(this);
    }
    ((RealTimeScanner) scanner).setupDirectoryWatcher();
    LOGGER.info(I18n.tl("initializing_end"));
  }

  public NotificationHandler getNotificationHandler() {
    return notifHandler;
  }

  public MetricsManager getMetricsManager() {
    return metrics;
  }

  public CommandLineParser getCommandLineParser() {
    return parser;
  }

  public Database getDatabase() {
    return DATABASE;
  }

  public static AntiMalware getInstance() {
    return instance;
  }

  public Scanner getScanner() {
    return scanner;
  }

  public CheckManager getCheckManager() {
    return CHECK_MANAGER;
  }

  public ServerHandler getServerHandler() {
    return serverHandler;
  }

  public CacheContainer getCache() {
    return cache;
  }

}
