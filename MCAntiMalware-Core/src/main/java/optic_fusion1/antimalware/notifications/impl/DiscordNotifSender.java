/*
* Copyright (C) 2021 Optic_Fusion1
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package optic_fusion1.antimalware.notifications.impl;

import club.minnced.discord.webhook.WebhookClient;
import club.minnced.discord.webhook.send.WebhookEmbed;
import club.minnced.discord.webhook.send.WebhookEmbedBuilder;
import club.minnced.discord.webhook.send.WebhookMessageBuilder;
import java.nio.file.Path;
import java.util.concurrent.ExecutionException;
import java.util.logging.Level;
import java.util.logging.Logger;
import optic_fusion1.antimalware.notifications.NotificationSender;
import optic_fusion1.antimalware.check.CheckResult;

public class DiscordNotifSender implements NotificationSender {

    private static final WebhookClient CLIENT = WebhookClient.withUrl(System.getenv("discord_webhook"));

    @Override
    public void sendNotification(Path path, CheckResult result) {
        try {
            WebhookMessageBuilder packet = new WebhookMessageBuilder();
            packet.setUsername("AntiMalwareScanner");
            String pluginName = path.getParent().getParent().getFileName().toString();
            WebhookEmbedBuilder embed = new WebhookEmbedBuilder();
            embed.setTitle(new WebhookEmbed.EmbedTitle("[Detected] " + result.getFamily(), "https://www.google.com")); // TODO: Come up w/ some sort of link
            embed.setDescription("Plugin " + pluginName + String.format(" might be infected with %s.%s.%s.%s Class path: %s ; Line/SourceFile %d/%s",
                    result.getPlatform(), result.getType(), result.getFamily(), result.getVariant(),
                    result.getClassNodePath(), result.getLine(), result.getSourceFilePath()));
            embed.setColor(16711680);
            
            packet.addEmbeds(embed.build());
            CLIENT.send(packet.build()).get();
        } catch (InterruptedException | ExecutionException ex) {
            Logger.getLogger(DiscordNotifSender.class.getName()).log(Level.SEVERE, null, ex);
        }
    }

}
