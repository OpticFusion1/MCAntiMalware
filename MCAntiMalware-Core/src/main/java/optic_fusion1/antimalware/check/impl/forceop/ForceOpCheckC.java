package optic_fusion1.antimalware.check.impl.forceop;

import optic_fusion1.antimalware.check.BaseCheck;
import optic_fusion1.antimalware.check.CacheContainer;
import optic_fusion1.antimalware.check.CheckResult;
import org.objectweb.asm.Opcodes;
import org.objectweb.asm.tree.*;

import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;

public class ForceOpCheckC extends BaseCheck {

    @Override
    public List<CheckResult> process(ClassNode classNode, Path rootFolder, Path zipFile, CacheContainer cache) {
        List<CheckResult> result = new ArrayList<>();
        for (MethodNode methodNode : classNode.methods) {
            int i = detectForceOP(methodNode);
            if (i != -1) {
                result.add(new CheckResult("Spigot", "MALWARE", "ForceOP", "C", classNode.sourceFile,
                        classNode.name, i));
            }
        }
        return result;
    }

    // TODO: Look for other ways to detect force-ops
    public int detectForceOP(MethodNode node) {
        for (AbstractInsnNode instruction : node.instructions.toArray()) {
            if (instruction instanceof LdcInsnNode ldcInsnNode) {
                if (!(ldcInsnNode.cst instanceof String value)) {
                    continue;
                }
                if (!value.equalsIgnoreCase("setOp")) {
                    continue;
                }
                AbstractInsnNode next = instruction.getNext();
                if(!(next.getOpcode() == Opcodes.ICONST_1)) {
                    continue;
                }
                AbstractInsnNode nextNext = next.getNext();
                if (!(nextNext.getOpcode() == Opcodes.ANEWARRAY)) {
                    continue;
                }
                TypeInsnNode typeInsnNode = (TypeInsnNode) nextNext;
                if (!typeInsnNode.desc.equals(("java/lang/Class"))) {
                    continue;
                }
                AbstractInsnNode nextNextNext = nextNext.getNext();
                if (nextNextNext.getOpcode() != Opcodes.DUP) {
                    continue;
                }
                AbstractInsnNode nextNextNextNext = nextNextNext.getNext();
                if (nextNextNextNext.getOpcode() != Opcodes.ICONST_0) {
                    continue;
                }
                AbstractInsnNode nextNextNextNextNext = nextNextNextNext.getNext();
                if(nextNextNextNextNext.getOpcode() != Opcodes.GETSTATIC) {
                    continue;
                }
                FieldInsnNode fieldInsnNode = (FieldInsnNode) nextNextNextNextNext;
                if (!fieldInsnNode.owner.equals("java/lang/Boolean") && !fieldInsnNode.name.equals("TYPE") && !fieldInsnNode.desc.equals("Ljava/lang/Class")) {
                    continue;
                }
                AbstractInsnNode nextNextNextNextNextNext = nextNextNextNextNext.getNext();
                if (nextNextNextNextNextNext.getOpcode() != Opcodes.AASTORE) {
                    continue;
                }
                AbstractInsnNode nextNextNextNextNextNextNext = nextNextNextNextNextNext.getNext();
                if (nextNextNextNextNextNextNext.getOpcode() != Opcodes.INVOKEVIRTUAL) {
                    continue;
                }
                MethodInsnNode methodInsnNode = (MethodInsnNode) nextNextNextNextNextNextNext;
                if(!methodInsnNode.owner.equals("java/lang/Class") && !methodInsnNode.name.equals("getMethod") &&
                        !methodInsnNode.desc.equals("(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method;")) {
                    continue;
                }
                return 1;
            }
        }
        return -1;
    }

}