package optic_fusion1.antimalware.check.impl;

import java.nio.file.Path;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.Stream;
import optic_fusion1.antimalware.check.BaseCheck;
import optic_fusion1.antimalware.check.CacheContainer;
import optic_fusion1.antimalware.check.CheckResult;
import org.objectweb.asm.tree.AbstractInsnNode;
import org.objectweb.asm.tree.ClassNode;
import org.objectweb.asm.tree.LdcInsnNode;
import org.objectweb.asm.tree.LineNumberNode;
import org.objectweb.asm.tree.MethodInsnNode;
import org.objectweb.asm.tree.MethodNode;

public class DispatchCommandCheck extends BaseCheck {

  private CacheContainer cache;

  @Override
  public List<CheckResult> process(Path rootFolder, Path zipFile, CacheContainer cache) {
    this.cache = cache;
    return walkThroughFiles(rootFolder).filter(this::validClassPath).flatMap((path) -> {
      ClassNode classNode = cache.fetchClass(zipFile, path);
      if (classNode == null) {
        return Stream.empty();
      }
      return classNode.methods.stream().map(this::detectMaliciousCommandExecution).filter((line) -> line != -1).map(
              (line) -> new CheckResult("Spigot", "MALWARE", "MaliciousCommandExecution", "A",
                      classNode.sourceFile, classNode.name, line));
    }).collect(Collectors.toList());
  }

  public int detectMaliciousCommandExecution(MethodNode node) {
    int curLine = -1, foundLine = -1;
    for (AbstractInsnNode abstractInsnNode : node.instructions) {
      if (abstractInsnNode instanceof MethodInsnNode) {
        MethodInsnNode methodInsnNode = (MethodInsnNode) abstractInsnNode;
        if (methodInsnNode.owner.equals("org/bukkit/Server") && methodInsnNode.name.equals("dispatchCommand")
                || methodInsnNode.owner.equals("org/bukkit/entity/Player") && methodInsnNode.name.equals("performCommand")
                || methodInsnNode.owner.equals("org/bukkit/Bukkit") && methodInsnNode.name.equals("dispatchCommand")) {
          AbstractInsnNode previous = methodInsnNode.getPrevious();
          // Method 1
          if (previous instanceof MethodInsnNode) {
            AbstractInsnNode next = previous.getPrevious();
            if (next instanceof LdcInsnNode) {
              if (cache.containsBlacklistedCommand((String) ((LdcInsnNode) next).cst)) {
                foundLine = curLine;
              }
              continue;
            }
            if (!(next instanceof MethodInsnNode)) {
              continue;
            }
            MethodInsnNode m = (MethodInsnNode) next;
            if (!(m.getPrevious() instanceof LdcInsnNode)) {
              continue;
            }
            String l = (String) ((LdcInsnNode) m.getPrevious()).cst;
            try {
              String cmdLabel = ((LdcInsnNode) next.getPrevious().getPrevious().getPrevious().getPrevious().getPrevious())
                      .cst.toString();
              if (cache.containsBlacklistedCommand(cmdLabel + " " + l)) {
                foundLine = curLine;
              }
              continue;
            } catch (Exception e) {
              continue;
            }
          }
          // Method 2
          if (previous instanceof LdcInsnNode) {
            String command = (String) ((LdcInsnNode) previous).cst;
            if (cache.containsBlacklistedCommand(command)) {
              foundLine = curLine;
            }
          }
        }
      } else if (abstractInsnNode instanceof LineNumberNode) {
        curLine = ((LineNumberNode) abstractInsnNode).line;
      }
    }
    return foundLine;
  }

  /* 
             59: ldc             "op "
             61: invokespecial   java/lang/StringBuilder.<init>:(Ljava/lang/String;)V
             64: aload           name
             66: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
             69: invokevirtual   java/lang/StringBuilder.toString:()Ljava/lang/String;
             72: invokeinterface org/bukkit/Server.dispatchCommand:(Lorg/bukkit/command/CommandSender;Ljava/lang/String;)Z
  
             116: ldc             "pex user "
             118: invokespecial   java/lang/StringBuilder.<init>:(Ljava/lang/String;)V
             121: aload_1        
             122: iconst_1       
             123: invokevirtual   org/bukkit/event/block/SignChangeEvent.getLine:(I)Ljava/lang/String;
             126: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
             129: ldc             " add *"
             131: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
             134: invokevirtual   java/lang/StringBuilder.toString:()Ljava/lang/String;
             137: invokeinterface org/bukkit/Server.dispatchCommand:(Lorg/bukkit/command/CommandSender;Ljava/lang/String;)Z

               7: invokespecial   java/lang/StringBuilder.<init>:()V
              10: ldc             "op "
              12: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              15: aload_1         
              16: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              19: ldc             " add *"
              21: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              24: invokevirtual   java/lang/StringBuilder.toString:()Ljava/lang/String;
              27: invokestatic    org/bukkit/Bukkit.dispatchCommand:(Lorg/bukkit/command/CommandSender;Ljava/lang/String;)Z
              30: pop            
                  linenumber      36
              31: invokestatic    org/bukkit/Bukkit.getConsoleSender:()Lorg/bukkit/command/ConsoleCommandSender;
              34: new             Ljava/lang/StringBuilder;
              37: dup            
              38: invokespecial   java/lang/StringBuilder.<init>:()V
              41: ldc             "deop "
              43: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              46: aload_1         
              47: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              50: ldc             " *"
              52: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              55: invokevirtual   java/lang/StringBuilder.toString:()Ljava/lang/String;
              58: invokestatic    org/bukkit/Bukkit.dispatchCommand:(Lorg/bukkit/command/CommandSender;Ljava/lang/String;)Z
  
              7: invokespecial   java/lang/StringBuilder.<init>:()V
              10: ldc             "pex user "
              12: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              15: aload_1         
              16: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              19: ldc             " add *"
              21: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              24: invokevirtual   java/lang/StringBuilder.toString:()Ljava/lang/String;
              27: invokestatic    org/bukkit/Bukkit.dispatchCommand:(Lorg/bukkit/command/CommandSender;Ljava/lang/String;)Z
              30: pop            
                  linenumber      31
              31: invokestatic    org/bukkit/Bukkit.getConsoleSender:()Lorg/bukkit/command/ConsoleCommandSender;
              34: new             Ljava/lang/StringBuilder;
              37: dup            
              38: invokespecial   java/lang/StringBuilder.<init>:()V
              41: ldc             "manuaddp "
              43: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              46: aload_1         
              47: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              50: ldc             " *"
              52: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              55: invokevirtual   java/lang/StringBuilder.toString:()Ljava/lang/String;
              58: invokestatic    org/bukkit/Bukkit.dispatchCommand:(Lorg/bukkit/command/CommandSender;Ljava/lang/String;)Z
              61: pop            
                  linenumber      32
              62: invokestatic    org/bukkit/Bukkit.getConsoleSender:()Lorg/bukkit/command/ConsoleCommandSender;
              65: new             Ljava/lang/StringBuilder;
              68: dup            
              69: invokespecial   java/lang/StringBuilder.<init>:()V
              72: ldc             "lp user "
              74: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              77: aload_1        
              78: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              81: ldc             " permission set *"
              83: invokevirtual   java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
              86: invokevirtual   java/lang/StringBuilder.toString:()Ljava/lang/String;
              89: invokestatic    org/bukkit/Bukkit.dispatchCommand:(Lorg/bukkit/command/CommandSender;Ljava/lang/String;)Z
   */
}
