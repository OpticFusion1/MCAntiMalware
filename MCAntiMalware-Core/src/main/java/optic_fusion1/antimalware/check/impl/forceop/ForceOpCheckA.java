package optic_fusion1.antimalware.check.impl.forceop;

import optic_fusion1.antimalware.check.BaseCheck;
import optic_fusion1.antimalware.check.CacheContainer;
import optic_fusion1.antimalware.check.CheckResult;
import optic_fusion1.antimalware.utils.ByteCodeUtils;
import org.objectweb.asm.tree.*;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;

public class ForceOpCheckA extends BaseCheck {

    private static final List<String> METHOD_INSN_NODE_OWNERS = new ArrayList<>();

    static {
        METHOD_INSN_NODE_OWNERS.add("org/bukkit/entity/Player");
        METHOD_INSN_NODE_OWNERS.add("org/bukkit/OfflinePlayer");
        METHOD_INSN_NODE_OWNERS.add("org/bukkit/command/CommandSender");
        METHOD_INSN_NODE_OWNERS.add("org/bukkit/permissions/ServerOperator");
    }

    @Override
    public List<CheckResult> process(ClassNode classNode, Path rootFolder, Path zipFile, CacheContainer cache) {
        List<CheckResult> results = new ArrayList<>();
        for (MethodNode methodNode : classNode.methods) {
            int i = detect(methodNode);
            if(i == -1) {
                continue;
            }
            results.add(new CheckResult("Spigot", "MALWARE", "ForceOP", "A", classNode.sourceFile, classNode.name, i));
        }
        return results;
    }

    private int detect(MethodNode methodNode) {
        boolean setOpTrue = false;
        boolean setOpFalse = false;
        int curLine = -1;
        int foundLine = -1;
        for (AbstractInsnNode instruction : methodNode.instructions) {
            if (instruction instanceof MethodInsnNode) {
                MethodInsnNode methodInsnNode = (MethodInsnNode)  instruction;
                if (methodInsnNode.owner.equals("org/bukkit/entity/Player") || methodInsnNode.owner.equals("org/bukkit/OfflinePlayer")
                        || methodInsnNode.owner.equals("org/bukkit/command/CommandSender")  || methodInsnNode.owner.equals("org/bukkit/permissions/ServerOperator")) {
                    if(!methodInsnNode.name.equals("setOp")) {
                        continue;
                    }
                    if(!methodInsnNode.desc.equals("(Z)V")){
                        continue;
                    }
                    AbstractInsnNode previous = methodInsnNode.getPrevious();
                    if (ByteCodeUtils.matches(previous, 1)) {
                        setOpTrue = true;
                        foundLine = curLine;
                    } else if (ByteCodeUtils.matches(previous, 0)){
                        setOpFalse = true;
                    }
                }
            } else if (instruction instanceof LineNumberNode) {
                curLine = ((LineNumberNode) instruction).line;
            }
        }
        return (setOpTrue && !setOpFalse) ? foundLine : -1;
    }

}
