package optic_fusion1.mcantimalware.transformer;

import me.yamakaja.runtimetransformer.annotation.Inject;
import me.yamakaja.runtimetransformer.annotation.InjectionType;
import me.yamakaja.runtimetransformer.annotation.Transform;
import net.minecraft.server.v1_15_R1.ServerCommand;
import optic_fusion1.mcantimalware.AntiMalware;
import optic_fusion1.mcantimalware.exceptions.FormattedSecurityException;
import optic_fusion1.mcantimalware.runtimeprotect.callerinfo.CallerInfo;
import optic_fusion1.mcantimalware.runtimeprotect.callerinfo.RuntimeUtils;
import org.bukkit.command.CommandSender;
import org.bukkit.craftbukkit.v1_15_R1.CraftServer;

@Transform(CraftServer.class)
public abstract class CraftServerTransformer1_15 {

  @Inject(InjectionType.INSERT)
  public boolean dispatchCommand(CommandSender sender, String commandLine) {
    CallerInfo callerInfo = RuntimeUtils.getCallerInfo();
    if (callerInfo != null) {
      if (AntiMalware.getCheckManager().isPluginJarBlacklisted(callerInfo.getPlugin().getJar())) {
        throw new FormattedSecurityException("{0} tried running the command {1} from the plugin {2}", new Object[]{sender.getName(), commandLine, callerInfo.getPlugin().getJar()});
      }
    }
    throw null;
  }

  @Inject(InjectionType.INSERT)
  public boolean dispatchServerCommand(CommandSender sender, ServerCommand serverCommand) {
    CallerInfo callerInfo = RuntimeUtils.getCallerInfo();
    if (callerInfo != null) {
      if (AntiMalware.getCheckManager().isPluginJarBlacklisted(callerInfo.getPlugin().getJar())) {
        throw new FormattedSecurityException("{0} tried running the command {1} from the plugin {2}", new Object[]{sender.getName(), serverCommand.command, callerInfo.getPlugin().getJar()});
      }
    }
    throw null;
  }

}
