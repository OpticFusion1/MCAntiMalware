package optic_fusion1.mcantimalware.realtimescanning;

import java.io.File;
import java.io.IOException;
import java.nio.file.Path;
import joptsimple.OptionSet;
import optic_fusion1.mcantimalware.AntiMalware;
import optic_fusion1.mcantimalware.Main;
import optic_fusion1.mcantimalware.check.CheckManager;
import optic_fusion1.mcantimalware.logging.CustomLogger;

public class RealTimeScanner {

    private DirectoryWatcher directoryWatcher;
    private CustomLogger logger = AntiMalware.getLogger();
    private CheckManager checkManager = AntiMalware.getMain().getCheckManager();
    private Main main;
    private Scanner scanner;
    private File scanDirectory = new File("plugins");

    public RealTimeScanner(Main main) {
        this.main = main;
        scanner = main.getScanner();
        OptionSet options = main.getOptions();
        if (options.has("scandirectory")) {
            scanDirectory = new File((String) options.valueOf("scandirectory"));
            scanner.setScanDirectory(scanDirectory);
        }
        if (!scanDirectory.exists()) {
            logger.alert("The scan directory '" + scanDirectory.getName() + "' doesn't exist");
            System.exit(0);
        }
    }

    public void setupDirectoryWatcher() {
        directoryWatcher = new DirectoryWatcher.Builder()
                .addDirectories(scanDirectory.toPath())
                .setPreExistingAsCreated(true)
                .build((DirectoryWatcher.Event event, Path path) -> {
                    switch (event) {
                        case ENTRY_CREATE:
                            if (main.shouldLogDebugMessages()) {
                                logger.debug("The file '" + path + "' was created");
                            }
                            try {
                                scanner.scanFile(path.toFile());
                            } catch (IOException ex) {
                                if (main.shouldLogDebugMessages()) {
                                    logger.exception(ex);
                                }
                            }
                            break;

                        case ENTRY_MODIFY:
                            if (main.shouldLogDebugMessages()) {
                                logger.debug("The file '" + path + "' was modified");
                            }
                            try {
                                scanner.scanFile(path.toFile());
                            } catch (IOException ex) {
                                if (main.shouldLogDebugMessages()) {
                                    logger.exception(ex);
                                }
                            }
                            break;
                        case ENTRY_DELETE:
                            if (main.shouldLogDebugMessages()) {
                                logger.debug("The file '" + path + "' was deleted");
                            }
                            break;
                    }
                });
        try {
            directoryWatcher.start();
        } catch (Exception ex) {
            if (main.shouldLogDebugMessages()) {
                logger.exception(ex);
            }
        }
    }
}
