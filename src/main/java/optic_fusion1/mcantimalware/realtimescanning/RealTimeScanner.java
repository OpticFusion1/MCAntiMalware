package optic_fusion1.mcantimalware.realtimescanning;

import java.io.File;
import java.io.IOException;
import java.nio.file.Path;
import joptsimple.OptionSet;
import optic_fusion1.mcantimalware.AntiMalware;
import optic_fusion1.mcantimalware.Main;
import optic_fusion1.mcantimalware.logging.CustomLogger;
import optic_fusion1.mcantimalware.translations.TranslationFile;

public class RealTimeScanner {

    private final CustomLogger logger = AntiMalware.getMain().getLogger();
    private final Main main;
    private final Scanner scanner;
    private File scanDirectory = new File("plugins");
    private final TranslationFile translations;

    public RealTimeScanner(Main main) {
        this.main = main;
        translations = main.getTranslations();
        scanner = new Scanner(main);
        if (!main.scanSingleFile()) {
            OptionSet options = main.getOptions();
            if (options.has("scandirectory")) {
                scanDirectory = new File((String) options.valueOf("scandirectory"));
                scanner.setScanDirectory(scanDirectory);
            }
            if (!scanDirectory.exists()) {
                logger.alert(translations.getMessage("scan_dir_doesn't_exist", scanDirectory.getName()));
                System.exit(0);
            }
        }
    }

    public void setupDirectoryWatcher() {
        DirectoryWatcher directoryWatcher = new DirectoryWatcher.Builder()
                .translations(main.getTranslations())
                .addDirectories(scanDirectory.toPath())
                .setPreExistingAsCreated(true)
                .build((DirectoryWatcher.Event event, Path path) -> {
                    switch (event) {
                        case ENTRY_CREATE:
                            if (main.shouldLogDebugMessages()) {
                                logger.debug(translations.getMessage("file_created", path));
                            }
                            try {
                                scanner.scanFile(path.toFile());
                            } catch (IOException ex) {
                                if (main.shouldLogDebugMessages()) {
                                    logger.exception(ex);
                                }
                            }
                            break;

                        case ENTRY_MODIFY:
                            if (main.shouldLogDebugMessages()) {
                                logger.debug(translations.getMessage("file_modified", path));
                            }
                            try {
                                scanner.scanFile(path.toFile());
                            } catch (IOException ex) {
                                if (main.shouldLogDebugMessages()) {
                                    logger.exception(ex);
                                }
                            }
                            break;
                        case ENTRY_DELETE:
                            if (main.shouldLogDebugMessages()) {
                                logger.debug(translations.getMessage("file_deleted", path));
                            }
                            break;
                    }
                });
        directoryWatcher.run();
    }

    public File getScanDirectory() {
        return scanDirectory;
    }

    public Scanner getScanner() {
        return scanner;
    }

}
