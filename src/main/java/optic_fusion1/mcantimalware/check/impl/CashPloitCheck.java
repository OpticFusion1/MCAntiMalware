package optic_fusion1.mcantimalware.check.impl;

import java.io.IOException;
import java.util.Base64;
import java.util.Enumeration;
import java.util.zip.ZipEntry;
import java.util.zip.ZipFile;
import optic_fusion1.mcantimalware.Main;
import optic_fusion1.mcantimalware.check.BaseCheck;
import org.apache.commons.io.IOUtils;

public class CashPloitCheck extends BaseCheck {

    private static final Base64.Decoder DECODER = Base64.getDecoder();

    public CashPloitCheck(String name) {
        super(name);
    }

    @Override
    public boolean process(String fileName, ZipFile zipFile) {
        if (isCashploitData(getInfoClass(zipFile))) {
            addToScore(1000);
            return true;
        }
        return false;
    }

    private byte[] getInfoClass(ZipFile zip) {
        try {
            String filePath = zip.getName();
            Enumeration<? extends ZipEntry> entries = zip.entries();
            while (entries.hasMoreElements()) {
                ZipEntry e = entries.nextElement();
                if (e.getName().equals("info.class")) {
                    setClassNodePath(e.getName());
                    byte[] content;
                    try (ZipFile tempZip = new ZipFile(filePath)) {
                        content = IOUtils.toByteArray(tempZip.getInputStream(e));
                    }
                    return content;
                }
            }
        } catch (IOException e) {
            if (MAIN.shouldLogExceptions()) {
                LOGGER.exception(e);
            }
        }
        return null;
    }

    private boolean isCashploitData(byte[] content) {
        if (content == null) {
            return false;
        }
        try {
            //Cashploit is a griefing plugin which stores its trustcommand in the info.class (3x base64 encoded)
            DECODER.decode(DECODER.decode(DECODER.decode(content)));
            return true;
        } catch (Exception ex) {
            if (MAIN.shouldLogExceptions()) {
                LOGGER.exception(ex);
            }
        }
        return false;
    }

}
