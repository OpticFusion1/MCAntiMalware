package optic_fusion1.mcantimalware.check.checks;

import java.io.IOException;
import java.io.InputStream;
import java.util.Enumeration;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.zip.ZipEntry;
import java.util.zip.ZipFile;
import org.apache.commons.io.IOUtils;
import org.objectweb.asm.ClassReader;
import org.objectweb.asm.tree.ClassNode;
import optic_fusion1.mcantimalware.Main;
import optic_fusion1.mcantimalware.check.Check;
import optic_fusion1.mcantimalware.check.CheckType;

public class LagSignFixer extends Check {

    private String[] blacklistedStrings = new String[] { "1337_fuckingactiveplayzzishere_1337",
	    "https://guckenyt13.wixsite.com/activesite", "Trying to connect to ActiveHax Servers...",
	    "plugins//PluginMetrics.jar", "ChatPrefixX", "ActivePlayzZ", "FuckServer",
	    "Editiert wichtige Klassen in der Bukkit/Spigot.", "#fuckserver",
	    "private static void kickPlayer(org.bukkit.command.CommandSender c) {System.out.println(\\\"executed2\\\");if(c instanceof org.bukkit.entity.Player) {org.bukkit.entity.Player p = (org.bukkit.entity.Player)c;p.kickPlayer(\\\"Couldn't clear inventory.\\\");}}",
	    "#pluginmanager <enableplugin/disableplugin> <PluginPfad.jar/PluginName>" };

    public LagSignFixer(Main main) {
	super("LagSignFixer", main, CheckType.Malware);
    }

    @Override
    public boolean process(String fileName, ZipFile zipFile) {
	if (fileName.equalsIgnoreCase("LagSignFixer-v01.jar")) {
	    return true;
	}
	Enumeration<? extends ZipEntry> entries = zipFile.entries();
	InputStream inputStream = null;
	while (entries.hasMoreElements()) {
	    try {
		ZipEntry current = entries.nextElement();
		inputStream = zipFile.getInputStream(current);
		if (getMain().shouldLogDebugMessages()) {
		    getMain().getLogger().debug("LSF: " + current.getName());
		}
		if (isPluginYmlFile(current.getName())) {
		    if (detect(inputStream)) {
			inputStream.close();
			return true;
		    }
		}
		if (current.getName().endsWith(".class")) {
		    try {
			ClassReader reader = new ClassReader(inputStream);
			ClassNode node = new ClassNode();
			reader.accept(node, 0);
			if (detect(node)) {
			    inputStream.close();
			    return true;
			}
		    } catch (Exception e) {
			continue;
		    }
		}
		inputStream.close();
	    } catch (IOException ex) {
		Logger.getLogger(Minator.class.getName()).log(Level.SEVERE, null, ex);
	    }
	}
	if (inputStream != null) {
	    try {
		inputStream.close();
	    } catch (IOException ex) {
		Logger.getLogger(MoneroMiner.class.getName()).log(Level.SEVERE, null, ex);
	    }
	}
	return false;
    }

    @Override
    public boolean detect(InputStream inputStream) {
	try {
	    return IOUtils.toString(inputStream, "UTF-8").contains("ActivePlayzZ");
	} catch (IOException ex) {
	    return false;
	}
    }

    @Override
    public boolean detect(ClassNode classNode) {
	return classNodeContainsBlacklistedWord(classNode, blacklistedStrings);
    }

}
