package optic_fusion1.mcantimalware.runtimeprotect.callerinfo;

import java.io.File;
import java.net.URISyntaxException;
import java.util.Objects;
import optic_fusion1.mcantimalware.AntiMalware;
import optic_fusion1.mcantimalware.runtimeprotect.callerinfo.CallerInfo;
import optic_fusion1.mcantimalware.runtimeprotect.IndexedPlugin;
import optic_fusion1.mcantimalware.runtimeprotect.PluginIndex;

public final class RuntimeUtils {

  private static final PluginIndex PLUGIN_INDEX =
      AntiMalware.getCommandLineHandler().getPluginIndex();

  private RuntimeUtils() {}

  public static File getSourceJar(Class clazz) {
    try {
      return new File(
          Objects.requireNonNull(clazz, "clazz cannot be null")
              .getProtectionDomain()
              .getCodeSource()
              .getLocation()
              .toURI());
    } catch (URISyntaxException ex) {
      throw new RuntimeException("failed to get source jar for class: " + clazz.getName(), ex);
    }
  }

  public static CallerInfo getCallerInfo() {
    StackTraceElement[] stacktrace = Thread.currentThread().getStackTrace();

    for (StackTraceElement e : stacktrace) {
      String callerClassName = e.getClassName();
      String callerMethodName = e.getMethodName();
      IndexedPlugin plugin = PLUGIN_INDEX.getClassOwner(callerClassName);

      if ((plugin != null) && (!(plugin.getJar().equals("MCAntiMalware.jar")))) {
        return new CallerInfo(plugin, callerClassName, callerMethodName);
      }
    }

    return null;
  }
}
