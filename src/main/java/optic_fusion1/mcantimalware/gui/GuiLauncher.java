package optic_fusion1.mcantimalware.gui;

import javafx.application.Application;
import javafx.fxml.FXMLLoader;
import javafx.scene.Group;
import javafx.scene.Scene;
import javafx.scene.text.Font;
import javafx.stage.Stage;
import optic_fusion1.mcantimalware.Main;
import optic_fusion1.mcantimalware.configuration.file.YamlConfiguration;
import optic_fusion1.mcantimalware.gui.controllers.Dashboard;
import optic_fusion1.mcantimalware.gui.controllers.Settings;
import optic_fusion1.mcantimalware.gui.theme.ThemeInfo;
import optic_fusion1.mcantimalware.gui.theme.ThemeLoader;
import org.apache.commons.io.FileUtils;

import java.io.File;
import java.io.IOException;

import static optic_fusion1.mcantimalware.AntiMalware.getMain;

public class GuiLauncher extends Application {
    private static final File DIR = new File(FileUtils.getUserDirectory(), ".mcantimalware");
    private static final File OPTIONS_FILE = new File(DIR, "options.yml");
    public static Stage stage;
    private static Scene scene;
    private static boolean GUIReady;
    private static ThemeInfo theme;

    public static void loadConf(){
        if(!DIR.exists()){
            DIR.mkdirs();
            return;
        }
        if(!OPTIONS_FILE.exists()){
            try {
                OPTIONS_FILE.createNewFile();
            } catch (IOException e) {
                e.printStackTrace();
            }
            return;
        }
        YamlConfiguration conf = YamlConfiguration.loadConfiguration(OPTIONS_FILE);
        String selectedDirs = conf.getString("selected_dir");
        if(selectedDirs != null) getMain().setScanDirectory(new File(selectedDirs));
        getMain().setFalsePositivesGalore(conf.getBoolean("false_positives_galore"));
        getMain().setZipMaliciousPlugins(conf.getBoolean("zip_mal_plugins"));
        applyTheme(conf.getString("selected_theme", "default"));
    }

    public static void saveConf(){
        YamlConfiguration conf = new YamlConfiguration();
        conf.set("selected_dir", getMain().getScanDirectory().getPath());
        conf.set("false_positives_galore", getMain().falsePositivesGalore());
        conf.set("zip_mal_plugins", getMain().shouldZipMaliciousPlugins());
        conf.set("selected_theme", theme.getName());
        try {
            conf.save(OPTIONS_FILE);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    public static ThemeInfo getThemeByName(String name) {
        return ThemeLoader.load(GuiLauncher.class, "/themes/"+name+"/");
    }

    public static ThemeInfo getCurrentTheme() {
        return theme;
    }

    public static void applyTheme(String name){
        applyTheme(getThemeByName(name));
    }

    public static void applyTheme(ThemeInfo info){
        if(theme != null && info.getFxmlPaths().size() < theme.getFxmlPaths().size()){
            info.getFxmlPaths().putAll(theme.getFxmlPaths());
        }
        theme = info;
        scene.getStylesheets().clear();
        scene.getStylesheets().addAll(info.getCssPaths());
        info.getFontPaths().forEach(s -> Font.loadFont(s, 10));
    }

    private static void loadFXML(String name, Object controller){
        try {
            FXMLLoader loader = new FXMLLoader(theme.getFxmlPaths().get(name));
            loader.setController(controller);
            scene.setRoot(loader.load());
        } catch(IOException e) {
            e.printStackTrace();
        }
    }

    public static void openDashboard(){
        loadFXML("dashboard", new Dashboard());
    }

    public static void openSettings(){
        loadFXML("settings", new Settings());
    }

    public static void start() {
        launch();
    }

    public static boolean isGUIReady() {
        return GUIReady;
    }

    @Override
    public void start(Stage primaryStage) {
        scene = new Scene(new Group(), 600, 400);
        primaryStage.setScene(scene);
        primaryStage.setTitle("MCAntiMalware");
        primaryStage.setResizable(false);
        primaryStage.setOnCloseRequest(event -> System.exit(0));
        applyTheme(getThemeByName("default"));
        primaryStage.show();

        stage = primaryStage;
        openDashboard();
        new Thread(() -> {
            new Main().init();
            loadConf();

            GUIReady = true;
            openDashboard(); // reload
        }).start();
    }
}
