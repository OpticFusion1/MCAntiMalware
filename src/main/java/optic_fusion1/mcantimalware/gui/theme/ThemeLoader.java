package optic_fusion1.mcantimalware.gui.theme;

import optic_fusion1.mcantimalware.AntiMalware;
import optic_fusion1.mcantimalware.configuration.Configuration;
import optic_fusion1.mcantimalware.configuration.ConfigurationSection;
import optic_fusion1.mcantimalware.configuration.file.YamlConfiguration;

import java.io.File;
import java.io.InputStreamReader;
import java.net.MalformedURLException;
import java.util.Set;
import java.util.stream.Collectors;

public class ThemeLoader {
    public static ThemeInfo load(File infoFile){
        Configuration conf = YamlConfiguration.loadConfiguration(infoFile);
        ThemeInfo info = new ThemeInfo(conf.getString("name"), conf.getString("author"));
        info.getCredits().addAll(conf.getStringList("credits"));
        info.getCssPaths().addAll(conf.getStringList("resources.styles"));
        info.getFontPaths().addAll(conf.getStringList("resources.fonts"));
        ConfigurationSection fxml = conf.getConfigurationSection("resources.fxml");
        if(fxml != null){
            Set<String> keys = fxml.getKeys(false);
            try {
                for (String key : keys) {
                    info.getFxmlPaths().put(key, new File(key).toURI().toURL());
                }
            } catch (MalformedURLException e) {
                e.printStackTrace();
                AntiMalware.getMain().getLogger().error("Failed to load FXML files ("+infoFile.getPath()+")");
            }
        }
        return info;
    }

    public static ThemeInfo load(Class<?> clazz, String path){
        Configuration conf = YamlConfiguration.loadConfiguration(new InputStreamReader(
                clazz.getResourceAsStream(path+"info.yml")));
        ThemeInfo info = new ThemeInfo(conf.getString("name"), conf.getString("author"));
        info.getCredits().addAll(conf.getStringList("credits"));
        info.getCssPaths().addAll(conf.getStringList("resources.styles").stream()
                .map(s -> clazz.getResource(path+s).toExternalForm())
                .collect(Collectors.toList()));
        info.getFontPaths().addAll(conf.getStringList("resources.fonts").stream()
                .map(s -> clazz.getResource(path+s).toExternalForm())
                .collect(Collectors.toList()));
        ConfigurationSection fxml = conf.getConfigurationSection("resources.fxml");
        if(fxml != null){
            Set<String> keys = fxml.getKeys(false);
            for (String key : keys) {
                info.getFxmlPaths().put(key, clazz.getResource(path+fxml.get(key)));
            }
        }
        return info;
    }
}
