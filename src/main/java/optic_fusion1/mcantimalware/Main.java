package optic_fusion1.mcantimalware;

import joptsimple.OptionParser;
import joptsimple.OptionSet;
import optic_fusion1.mcantimalware.check.CheckManager;
import optic_fusion1.mcantimalware.check.CheckRegistery;
import optic_fusion1.mcantimalware.configuration.file.FileConfiguration;
import optic_fusion1.mcantimalware.configuration.file.YamlConfiguration;
import optic_fusion1.mcantimalware.gui.GuiLauncher;
import optic_fusion1.mcantimalware.logging.CustomLogger;
import optic_fusion1.mcantimalware.realtimescanning.RealTimeScanner;
import optic_fusion1.mcantimalware.realtimescanning.Scanner;
import optic_fusion1.mcantimalware.utils.JavaUtil;
import optic_fusion1.mcantimalware.utils.ZipUtils;
import org.apache.commons.io.FileUtils;
import org.apache.commons.io.IOUtils;
import org.apache.commons.lang.SystemUtils;
import org.apache.logging.log4j.Level;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.core.LoggerContext;
import org.apache.logging.log4j.core.config.Configuration;
import org.apache.logging.log4j.core.config.LoggerConfig;

import javax.swing.*;
import java.awt.*;
import java.io.File;
import java.io.IOException;
import java.net.URISyntaxException;
import java.net.URL;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

import static java.util.Arrays.asList;

public class Main implements Runnable {
    public static final File FX_SDK_DIR = new File(FileUtils.getUserDirectory(), ".fx_sdk/");
    private static final File FX_SDK_LIB_DIR = new File(FX_SDK_DIR, "lib");
    private static String javaFxPath = System.getenv("PATH_TO_FX");

    private Thread mainThread;
    private String[] args;
    private CustomLogger logger = CustomLogger.getLogger(Main.class);
    private boolean shouldLogDebugMessages;
    private boolean scanSingleFile;
    private OptionSet options;
    private FileConfiguration checksumDatabase;
    private FileConfiguration checkDatabase;
    private CheckManager checkManager;
    private Scanner scanner;
    private CheckRegistery checkRegistery;

    public static void main(String[] args) {
        Main main = new Main();
        main.args = args;
        main.mainThread = new Thread(main);
        main.mainThread.setName("AntiMalware[Main Thread]");
        main.mainThread.start();
    }

    private void init() {
        AntiMalware.setMain(this);
        setupLogger();
        handleCommandLineArguments();
        downloadCheckDatabase(false);
        downloadChecksumDatabase(false);
        checkManager = new CheckManager(this);
        checkRegistery = new CheckRegistery(this);
        checkRegistery.registerChecks();
    }

    @Override
    public void run() {
        init();
        scanner = new Scanner(this);
        if (scanSingleFile) {
            try {
                scanner.scanFile(new File((String) options.valueOf("scanfile")));
            } catch (IOException ex) {
                if (shouldLogDebugMessages) {
                    logger.exception(ex);
                }
            }
            System.exit(0);
        } else {
            setupAutoUpdater();
            if (GraphicsEnvironment.isHeadless()) {
                new RealTimeScanner(this).setupDirectoryWatcher();
            } else {
                if (JavaUtil.getJavaVersion() < 11) {
                    GuiLauncher.start();
                    return;
                }
                try {
                    Class.forName("javafx.application.Application");
                    GuiLauncher.start();
                } catch (ClassNotFoundException ignored) {
                    openGUIJava11();
                }
            }
        }
    }

    private void handleCommandLineArguments() {
        OptionParser parser = new OptionParser() {
            {
                acceptsAll(asList("zipMalPlugins"), "Whether to put every malicious plugin in a .zip file or not")
                        .withRequiredArg().ofType(Boolean.class).defaultsTo(false);
                acceptsAll(asList("debug"), "Whether or not to log debug messages").withRequiredArg()
                        .ofType(Boolean.class).defaultsTo(false);
                acceptsAll(asList("scandirectory"), "Which folder to scan").withRequiredArg()
                        .ofType(String.class).defaultsTo("plugins");
                acceptsAll(asList("scanfile"), "Scan a single file").withRequiredArg()
                        .ofType(String.class);
                acceptsAll(asList("printOnlyIfInfected"), "Only prints messages to the console if these are warnings about infected plugins.")
                        .withRequiredArg().ofType(Boolean.class).defaultsTo(false);
                acceptsAll(asList("help"), "Show the help");
            }
        };
        try {
            options = parser.parse(args);
        } catch (joptsimple.OptionException ex) {
            logger.exception(ex.toString());
        }
        if (options != null) {
            if (options.has("help")) {
                try {
                    parser.printHelpOn(System.out);
                } catch (IOException ex) {
                    logger.exception(ex);
                }
                System.exit(0);
            }
            if (options.has("debug")) {
                shouldLogDebugMessages = (Boolean) options.valueOf("debug");
            }
            if (options.has("scanfile")) {
                scanSingleFile = true;
            }
        }
    }

    private void setupLogger() {
        LoggerContext ctx = (LoggerContext) LogManager.getContext(false);
        Configuration config = ctx.getConfiguration();
        LoggerConfig loggerConfig = config.getLoggerConfig(LogManager.ROOT_LOGGER_NAME);
        loggerConfig.setLevel(Level.ALL);
        ctx.updateLoggers();
    }

    public CustomLogger getLogger() {
        return logger;
    }

    public boolean shouldLogDebugMessages() {
        return shouldLogDebugMessages;
    }

    private void setupAutoUpdater() {
        ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor();
        executor.scheduleWithFixedDelay(() -> {
            downloadCheckDatabase(true);
            downloadChecksumDatabase(true);
        }, 1, 4, TimeUnit.HOURS);
    }

    private void downloadCheckDatabase(boolean updateDatabase) {
        try {
            if (shouldLogDebugMessages()) {
                logger.debug("DATABASE");
                logger.debug(IOUtils.toString(new URL("https://raw.githubusercontent.com/OpticFusion1/MCAntiMalwareDatabase/master/database.yml"), "UTF-8"));
            }
            logger.info("Downloading check database" + (updateDatabase ? "(AUTO-UPDATE)" : ""));
            checkDatabase = YamlConfiguration.loadConfiguration(IOUtils.toInputStream(IOUtils.toString(new URL("https://raw.githubusercontent.com/OpticFusion1/MCAntiMalwareDatabase/master/database.yml"), "UTF-8"), "UTF-8"));
            logger.info("Finished downloading check database" + (updateDatabase ? "(AUTO-UPDATE)" : ""));
            if (updateDatabase) {
                logger.info("Reloading local check database");
                checkRegistery.reloadCheckDatabase();
                checkRegistery.registerChecks();
                logger.info("Finished reloading check local database");
                logger.info("Rescanning due to updated database");
                scanner.scanFiles();
                logger.info("Finished rescanning");
            }
        } catch (IOException ex) {
            if (shouldLogDebugMessages()) {
                logger.exception(ex);
            }
        }
    }

    private void downloadChecksumDatabase(boolean update) {
        try {
            if (shouldLogDebugMessages()) {
                logger.debug("DATABASE");
                logger.debug(IOUtils.toString(new URL("https://raw.githubusercontent.com/OpticFusion1/MCAntiMalwareDatabase/master/checksums.yml"), "UTF-8"));
            }
            logger.info("Downloading checksum database" + (update ? "(AUTO-UPDATE)" : ""));
            checksumDatabase = YamlConfiguration.loadConfiguration(IOUtils.toInputStream(IOUtils.toString(new URL("https://raw.githubusercontent.com/OpticFusion1/MCAntiMalwareDatabase/master/checksums.yml"), "UTF-8"), "UTF-8"));
            logger.info("Finished downloading checksum database" + (update ? "(AUTO-UPDATE)" : ""));
            if (update) {
                logger.info("Reloading local checksum database");
                scanner.reloadChecksumDatabase();
                logger.info("Reloaded local checksum database");
                logger.info("Rescanning due to updated database");
                scanner.scanFiles();
                logger.info("Finished rescanning");
            }
        } catch (IOException ex) {
            if (shouldLogDebugMessages()) {
                logger.exception(ex);
            }
        }
    }

    private static void openGUIJava11() {
        if(javaFxPath == null){
            javaFxPath = FX_SDK_LIB_DIR.getPath();
            if(!FX_SDK_LIB_DIR.exists()) {
                JOptionPane.showMessageDialog(null, "Look like your system hasn't had JavaFX SDK yet. We will try to install it :D");
                String url;
                if (SystemUtils.IS_OS_WINDOWS) url = "https://download2.gluonhq.com/openjfx/11.0.2/openjfx-11.0.2_windows-x64_bin-sdk.zip";
                else if(SystemUtils.IS_OS_LINUX) url = "https://download2.gluonhq.com/openjfx/11.0.2/openjfx-11.0.2_linux-x64_bin-sdk.zip";
                else if(SystemUtils.IS_OS_MAC_OSX) url = "https://download2.gluonhq.com/openjfx/11.0.2/openjfx-11.0.2_osx-x64_bin-sdk.zip";
                else {
                    JOptionPane.showMessageDialog(null, "Unable to find a suitable SDK for your system :<");
                    return;
                }
                File sdkFile = new File(FileUtils.getTempDirectory(), "fx_sdk.tmp");
                try {
                    if(!sdkFile.exists()) {
                        JOptionPane.showMessageDialog(null, "Please wait until you see the next popup!");
                        FileUtils.copyURLToFile(new URL(url), sdkFile);
                    }
                    JOptionPane.showMessageDialog(null, "The SDK has been downloaded! Now we are installing it...");
                    ZipUtils.unzip(sdkFile, FX_SDK_DIR, 1);
                    sdkFile.deleteOnExit();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }

        new Thread(() -> {
            try {
                File currentJar = new File(Main.class.getProtectionDomain().getCodeSource().getLocation().toURI());
                Runtime.getRuntime().exec("javaw -p \""+javaFxPath+"\" --add-modules javafx.controls,javafx.fxml -jar \""+currentJar.getPath()+"\" optic_fusion1.mcantimalware.Main");
            } catch (IOException | URISyntaxException ex) {
                ex.printStackTrace();
            }
        }).start();
    }

    public CheckManager getCheckManager() {
        return checkManager;
    }

    public Scanner getScanner() {
        return scanner;
    }

    public FileConfiguration getChecksumDatabase() {
        return checksumDatabase;
    }

    public FileConfiguration getCheckDatabase() {
        return checkDatabase;
    }

    public OptionSet getOptions() {
        return options;
    }
}
